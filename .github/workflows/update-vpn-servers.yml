name: Update VPN Servers Gist

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: pip install requests
          
      - name: Update Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: b3049dbc387bf59cbf6810ae0ee90aff
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          
          # Fetch VPN servers
          vpn_response = requests.get(
              "http://www.vpngate.net/api/iphone/",
              headers={"User-Agent": "Mozilla/5.0"},
              timeout=10
          )
          vpn_response.raise_for_status()
          
          # Update Gist
          headers = {
              "Authorization": "Bearer " + os.environ["GIST_TOKEN"],
              "Accept": "application/vnd.github.v3+json"
          }
          
          data = {
              "files": {
                  "vpn_servers.json": {
                      "content": json.dumps({
                          "last_updated": datetime.now().isoformat(),
                          "data": vpn_response.text
                      })
                  }
              }
          }
          
          response = requests.patch(
              f"https://api.github.com/gists/{os.environ['GIST_ID']}",
              headers=headers,
              json=data
          )
          response.raise_for_status()
          print("Gist updated successfully")
          EOF
